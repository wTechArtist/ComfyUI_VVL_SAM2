# VVL Mask Cleaner 节点使用说明

## 概述
VVL Mask Cleaner 是一个专门用于清理和优化分割mask的ComfyUI节点。它可以自动填补mask内部的空洞并清除周围的零碎噪点，特别适合处理SAM2等分割模型的输出结果。

## 主要功能
1. **填补内部空洞** - 自动检测并填补白色区域内部的黑色空洞
2. **清除零碎遮罩** - 只保留最大的N个区域，删除小噪点

## 参数说明

### 输入参数
- **masks** (必需) - 输入的mask列表，通常来自SAM2等分割节点的输出

### 可选参数
- **keep_largest_n** (默认: 1)
  - 保留面积最大的N个白色区域
  - 取值范围：1-10
  - 设置为1时只保留最大的主体区域

- **processing_mode** (默认: "both")
  - `"both"` - 填补空洞 + 清理零碎区域（推荐）
  - `"fill_only"` - 只填补内部空洞
  - `"clean_only"` - 只清理零碎区域

### 输出
- **cleaned_masks** - 清理后的mask列表
- **processing_info** - 处理信息文本，显示填补了多少空洞、清理了多少区域等

## 使用示例

### 示例1：基础使用（单对象清理）
```
输入：SAM2分割的mask
参数：
- keep_largest_n: 1
- processing_mode: "both"
效果：填补所有内部空洞，只保留最大的主体区域
```

### 示例2：多对象保留
```
输入：包含多个对象的mask
参数：
- keep_largest_n: 3
- processing_mode: "both"
效果：保留3个最大的对象，每个对象都填补内部空洞
```

### 示例3：只填补空洞
```
输入：质量较好但有内部空洞的mask
参数：
- processing_mode: "fill_only"
效果：只填补空洞，不删除任何区域
```

### 示例4：只清理噪点
```
输入：对象完整但周围有噪点的mask
参数：
- keep_largest_n: 1
- processing_mode: "clean_only"
效果：只保留最大区域，删除所有小噪点
```

## 工作流集成

### 典型工作流
1. 图像输入 → SAM2分割 → **VVL Mask Cleaner** → 后续处理
2. GroundingDINO+SAM2 → **VVL Mask Cleaner** → 图像合成

### 与其他节点配合
- **输入来源**：VVL_GroundingDinoSAM2、SAM2、其他分割节点
- **输出用途**：图像合成、遮罩编辑、批量处理等

## 注意事项
1. 节点会自动处理不同格式的mask输入（tensor、numpy数组等）
2. 填补空洞操作会填补所有检测到的内部空洞
3. 清理操作基于区域面积大小，不考虑形状或位置
4. 处理顺序：先填补空洞，后清理零碎区域

## 常见问题

### Q: 为什么有些空洞没有被填补？
A: 可能是因为这些"空洞"实际上连接到了mask的外部边界，不是真正的内部空洞。

### Q: 如何保留所有区域只填补空洞？
A: 使用 `processing_mode="fill_only"`

### Q: 如何确定要保留几个区域？
A: 可以先查看原始mask中有多少个主要对象，然后相应设置 `keep_largest_n`

## 技术细节
- 使用OpenCV的连通域分析和形态学运算
- 动态调整形态学核大小以适应不同大小的区域
- 支持批量处理多个mask
- 内存优化的实现方式

## 更新日志
- v1.0 - 初始版本，实现基础的空洞填补和区域清理功能 